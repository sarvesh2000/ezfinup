<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/all.css'>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{url_for('static', filename='styles/madhu_dashboard.css')}}" />
    <title>Dashboard</title>
  </head>
  <body>
    <!-- navbar container -->
    <div class="navi-container">
      <nav
        class="navbar navbar-expand-lg navbar-light shadow-sm pl-3 pr-3 pt-2 pb-2 bg-white rounded fixed-top"
      >
        <a class="navbar-brand" href="#">EZFINUP</a>
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarNavDropdown"
          aria-controls="navbarNavDropdown"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="#"
                >NIFTY 50 <span class="text-danger">1444.85</span></a
              >
            </li>
            <li class="nav-item active">
              <a class="nav-link" href="#"
                >SENSEX <span class="text-danger">48431.23</span></a
              >
            </li>
          </ul>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item active">
              <a class="nav-link active" href="{{url_for('homepage')}}"><i class="fas fa-home"></i>Home</a>
            </li>
            {% if session['user_id'] %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{url_for('dashboard')}}"><i
                                class="fas fa-tachometer-alt"></i>Dashboard</a>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{url_for('login')}}"><i class="far fa-user"></i>Login</a>
                    </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link" href="{{url_for('aboutpage')}}"><i class="fas fa-address-card"></i>About Us</a>
                </li>
                {% if session['user_id'] %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{url_for('news')}}"><i class="far fa-clone"></i>News</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{url_for('logout')}}"><i class="fas fa-address-card"></i>Log Out</a>
                    </li>
                {% endif %}
          </ul>
        </div>
      </nav>
    </div>
    <!-- Main body container -->
    <div class="main-body-container container">
      <div class="row">
        <!-- Left container -->
        <div class="col-md-4 left-container pt-3">
          <form class="form-inline my-2 my-lg-0 pb-3">
            <input
              class="form-control mr-sm-2"
              type="search"
              placeholder="Search"
              aria-label="Search"
            />
            <button class="btn btn-secondary my-2 my-sm-0" type="submit">
              Search
            </button>
          </form>
          <div class="list-group-flush">
            <a href="#" class="list-group-item list-group-item-action mt-1">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 text-danger">
                  NIFTY 50 <small class="text-secondary">INDEX</small>
                </h6>
                <small class="text-secondary">-0.71%</small>
                <small class="text-danger">14436.35</small>
              </div>
            </a>
            <a href="#" class="list-group-item list-group-item-action mt-1" onclick="getReliance()">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 text-success">
                  RELIANCE 
                </h6>
                <small class="text-secondary">-0.71%</small>
                <small class="text-success">14436.35</small>
              </div>
            </a>
            <a href="#" class="list-group-item list-group-item-action mt-1" onclick="getIdea()">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 text-danger">
                  IDEA 
                </h6>
                <small class="text-secondary">-0.71%</small>
                <small class="text-danger">14436.35</small>
              </div>
            </a>
            <a href="#" class="list-group-item list-group-item-action mt-1" onclick="getAAPL()">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 text-danger">
                  AAPL
                </h6>
                <small class="text-secondary">-0.71%</small>
                <small class="text-danger">14436.35</small>
              </div>
            </a>
            <a href="#" class="list-group-item list-group-item-action mt-1" onclick="getTSLA()">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 text-success">
                  TSLA 
                </h6>
                <small class="text-secondary">-0.71%</small>
                <small class="text-success">14436.35</small>
              </div>
            </a>
          </div>
          <!-- <nav aria-label="Page navigation example">
            <ul class="pagination">
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav> -->
        </div>
        <!-- Right Container -->
        <div class="col-md-8 right-container pt-4 pb-4">
          <div id="graph" style="width: 100%; height: 500px; display: inline-block;"></div>
          <br>
          <div id="chartContainer" style="width: 100%; height: 500px; display: inline-block;"></div>
          
        </div>
      </div>
    </div>
    <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
      crossorigin="anonymous"
    ></script>

    <!--  Stock Chart  -->
  <script src="{{ url_for('static',filename='JS/jquery.canvasjs.stock.min.js') }}"></script>
  <!-- Moment js for date manipulation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js" integrity="sha512-LGXaggshOkD/at6PFNcp2V2unf9LzFq6LE+sChH7ceMTDP0g2kn6Vxwgg7wkPP7AAtX+lmPqPdxB47A0Nz0cMQ==" crossorigin="anonymous"></script>  <!--  Custom Script to show Algo Trading  -->
  <script>
    function generateAlgo(data, name) {
      var data1 = [];
      var data2 = [];
      var data3 = [];
      var data4 = [];
      var data5 = [];
      var min = new Date(data.dates[0]);
      var max = new Date(data.dates[data.dates.length - 1]);
      console.log("Algo Data", data);
      for (var i = 0; i < data.price.length; i++) {
        data1.push({ x: new Date(data.dates[i]), y: data.price[i] });
        if (data.SMA30[i] == "NONE")
          data2.push({ x: new Date(data.dates[i]), y: data.price[i] });
        else
          data2.push({ x: new Date(data.dates[i]), y: data.SMA30[i] });
        if (data.SMA100[i] == "NONE")
          data3.push({ x: new Date(data.dates[i]), y: data.price[i] });
        else
          data3.push({ x: new Date(data.dates[i]), y: data.SMA100[i] });
        if (data.buy_point[i] != "NONE")
          data4.push({ x: new Date(data.dates[i]), y: data.buy_point[i] })
        if (data.sell_point[i] != "NONE")
          data5.push({ x: new Date(data.dates[i]), y: data.sell_point[i] })
      }
      chartTitle = "Buy and Sell signals for " + name;
      var stockChart1 = new CanvasJS.StockChart("chartContainer", {
        title: {
          text: chartTitle
        },
        // subtitles: [{
        // text: "Mouse over Technical Indicator Menu to Add SMA, EMA and MACD",
        // fontSize: 12
        // }],
        theme: "light2",
        exportEnabled: true,
        charts: [{
          axisY: {
            prefix: "₹"
          },
          legend: {
            verticalAlign: "top",
            horizontalAlign: "left",
            cursor: "pointer"
          },
          toolTip: {
            shared: true
          },
          data: [{
            type: "line",
            showInLegend: true,
            name: "Stock Price",
            yValueFormatString: "₹#,###.00",
            dataPoints: data1
          }, {
            type: "line",
            showInLegend: true,
            name: "SMA 30",
            yValueFormatString: "₹#,###.00",
            dataPoints: data2
          },
          {
            type: "line",
            showInLegend: true,
            name: "SMA 100",
            yValueFormatString: "₹#,###.00",
            dataPoints: data3
          },
          {
            markerType: "triangle",  //"circle", "square", "cross", "none"
            showInLegend: true,
            name: "Buy",
            type: "scatter",
            dataPoints: data4
          },
          {
            markerType: "triangle",  //"circle", "square", "cross", "none"
            showInLegend: true,
            name: "Sell",
            type: "scatter",
            dataPoints: data5
          }],
        }],
        navigator: {
          data: [{
            dataPoints: data1
          }],
          slider: {
            minimum: min,
            maximum: max
          }
        }
      });
      stockChart1.render();
    }
  </script>
  <!--  Custom Script to call and get Prediction from Cloud  -->
  <script>
    function showGraph(data, name) {
      var chartTitle = "Price Prediction of " + name + " for the upcoming three days";
      var dataPoints = [];
      var data2 = [];
      var dat = data["data"];
      var stockChart = new CanvasJS.StockChart("graph", {
        exportEnabled: true,
        title: {
          text: chartTitle
        },
        charts: [{
          axisX: {
            crosshair: {
              enabled: true,
              snapToDataPoint: true,
              valueFormatString: "##"
            }
          },
          axisY: {
            title: "INR",
            prefix: "₹",
            crosshair: {
              enabled: true,
              snapToDataPoint: true,
              valueFormatString: "₹#,###.00",
            }
          },
          data: [{
            type: "line",
            xValueFormatString: "dd/mm/yyyy",
            yValueFormatString: "₹#,###.##",
            dataPoints: dataPoints
          },
          {
            type: "line",
            showInLegend: true,
            name: "Predicted Price",
            yValueFormatString: "₹#,###.00",
            dataPoints: data2
          }]
        }],
        navigator: {
          slider: {
            minimum: moment().subtract((103-dat[0]["x"][0]), 'days').toDate(),
            maximum: moment().subtract((103-dat[0]["y"][(dat[0]["y"].length)-1]), 'days').toDate()
          },
          enabled: true
        }
      });
      console.log("DAT ", dat);
      for (var i = 0; i < dat[0]["x"].length; i++) {
        for (var j = 0; j < dat[1]["x"][i].length; j++) {
          date = new Date(moment().subtract((103-dat[0]["x"][i]), 'days').toDate());
          dataPoints.push({ x: date, y: dat[1]["x"][i][j] });
        }
        console.log("Datapoints", dataPoints);
      }
      for (var i = (dat[0]["y"].length)-1; i >= 0; i--) {
        for (var j = (dat[1]["y"][i].length)-1; j >= 0; j--) {
          date = new Date(moment().subtract((103-dat[0]["y"][i]), 'days').toDate());
          data2.push({ x: date, y: dat[1]["y"][i][j] });
        }
        console.log("Datapoints", dataPoints);
        console.log("Data 2", data2);

      }
      stockChart.render();
    }
    function getIdea() {
      console.log("Clicked IDEA");
      $.ajax({
        url: "http://127.0.0.1:5001/?stockname=IDEA.NS",
        success: function (result) {
          // $("#graph").html(result);
          showGraph(result, "IDEA NSE");
        },
        fail: function (error) {
          console.log("Error:", error);
        }
      });
      console.log("2nd Call");
      $.ajax({
        url: "http://127.0.0.1:5002/?stockname=IDEA.NS",
        success: function (result) {
          console.log("2nd result ", result);
          generateAlgo(result, "IDEA NSE")
        },
        fail: function (error) {
          console.log("Error:", error);
        }
      });
    }
    function getAAPL() {
      console.log("Clicked AAPL");
      $.ajax({
        url: "http://127.0.0.1:5001/?stockname=AAPL",
        success: function (result) {
          // $("#graph").html(result);
          showGraph(result, "AAPL");
        },
        fail: function (error) {
          console.log("Error:", error);
        }
      });
      console.log("2nd Call");
      $.ajax({
        url: "http://127.0.0.1:5002/?stockname=AAPL",
        success: function (result) {
          console.log("2nd result ", result);
          generateAlgo(result, "AAPL")
        },
        fail: function (error) {
          console.log("Error:", error);
        }
      });
    }
    function getTSLA() {
      console.log("Clicked AAPL");
      $.ajax({
        url: "http://127.0.0.1:5001/?stockname=TSLA",
        success: function (result) {
          // $("#graph").html(result);
          showGraph(result, "TSLA");
        },
        fail: function (error) {
          console.log("Error:", error);
        }
      });
      console.log("2nd Call");
      $.ajax({
        url: "http://127.0.0.1:5002/?stockname=TSLA",
        success: function (result) {
          console.log("2nd result ", result);
          generateAlgo(result, "TSLA")
        },
        fail: function (error) {
          console.log("Error:", error);
        }
      });
    }
    function getReliance() {
      console.log("Clicked RELIANCE");
      $.ajax({
        url: "http://127.0.0.1:5001/?stockname=RELIANCE.NS",
        success: function (result) {
          // $("#graph").html(result);
          showGraph(result, "RELIANCE NSE");
        },
        fail: function (error) {
          console.log("Error:", error);
        }
      });
      $.ajax({
        url: "http://34.70.172.158:5000/?stockname=RELIANCE.NS",
        success: function (result) {
          console.log("2nd Result ", result);
          // $("#graph").html(result);
          generateAlgo(result, "RELIANCE NSE");
        },
        fail: function (error) {
          console.log("Error:", error);
        }
      });
    }
  </script>
  </body>
</html>
